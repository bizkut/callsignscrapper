services:
  # One-time scraper run
  scraper:
    build: .
    container_name: mcmc-scraper
    volumes:
      - ./data:/app/data
    environment:
      - PYTHONUNBUFFERED=1
    # Usage:
    # docker compose run --rm scraper python scraper.py           # Incremental
    # docker compose run --rm scraper python scraper.py --fresh   # Fresh scrape  
    # docker compose run --rm scraper python scraper.py --resume  # Resume from checkpoint

    # Scheduled weekly scraper
  scraper-scheduled:
    build: .
    container_name: mcmc-scraper-scheduled
    volumes:
      - ./data:/app/data
    environment:
      - PYTHONUNBUFFERED=1
    entrypoint: [ "/bin/sh", "-c" ]
    command:
      - |
        echo "Scheduled scraper started. Will run every Sunday at 2 AM."
        while true; do
          current_day=$$(date +%u)  # 1=Mon, 7=Sun
          current_hour=$$(date +%H)
          current_minute=$$(date +%M)
          
          # Run on Sunday (7) at 02:00
          if [ "$$current_day" = "7" ] && [ "$$current_hour" = "02" ] && [ "$$current_minute" = "00" ]; then
            echo "=== Starting scheduled scrape at $$(date) ==="
            
            # Run scraper with resume support
            python scraper.py --resume || python scraper.py
            
            echo "=== Scrape completed at $$(date) ==="
            echo "Records in database: $$(python -c \"import json; d=json.load(open('/app/data/callsigns.json')); print(len(d['assignments']))\")"
            
            # Sleep 1 hour to avoid re-running
            sleep 3600
          else
            sleep 60
          fi
        done
    profiles:
      - scheduled
    restart: unless-stopped
